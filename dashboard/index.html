<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau de bord de migration PHP vers NestJS/Remix</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    :root {
      --primary: #2d6cd8;
      --secondary: #6c757d;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --info: #17a2b8;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      color: #333;
    }
    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    .card {
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      border: none;
    }
    .card-header {
      font-weight: 600;
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
      background-color: white;
      border-radius: 8px 8px 0 0 !important;
    }
    .progress {
      height: 10px;
      border-radius: 5px;
    }
    .progress-bar {
      border-radius: 5px;
    }
    .nav-tabs .nav-link {
      border: none;
      color: var(--secondary);
      padding: 10px 15px;
    }
    .nav-tabs .nav-link.active {
      color: var(--primary);
      border-bottom: 2px solid var(--primary);
      background-color: transparent;
    }
    .status-badge {
      padding: 5px 10px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    .dependency-badge {
      background-color: #e9ecef;
      color: #495057;
      padding: 3px 8px;
      border-radius: 8px;
      font-size: 0.7rem;
      margin-right: 4px;
    }
    .complexity-low {
      color: var(--success);
    }
    .complexity-medium {
      color: var(--warning);
    }
    .complexity-high {
      color: var(--danger);
    }
    .icon-container {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 20px;
      margin-right: 15px;
    }
    .icon-blue {
      background-color: rgba(45, 108, 216, 0.1);
      color: var(--primary);
    }
    .icon-green {
      background-color: rgba(40, 167, 69, 0.1);
      color: var(--success);
    }
    .icon-yellow {
      background-color: rgba(255, 193, 7, 0.1);
      color: var(--warning);
    }
    .icon-red {
      background-color: rgba(220, 53, 69, 0.1);
      color: var(--danger);
    }
    .time-ago {
      font-size: 0.8rem;
      color: #6c757d;
    }
    #agent-dependencies-graph {
      width: 100%;
      height: 400px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .stat-card {
      text-align: center;
      padding: 15px;
    }
    .stat-card .value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
    }
    .stat-card .label {
      font-size: 0.9rem;
      color: var(--secondary);
      font-weight: 500;
    }
    .table-small {
      font-size: 0.9rem;
    }
    .table-small th {
      font-weight: 600;
    }
    .module-card {
      position: relative;
      margin-bottom: 15px;
    }
    .module-card .progress {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      border-radius: 0 0 8px 8px;
    }
    .dot {
      height: 10px;
      width: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
    }
    .issue-list {
      max-height: 400px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="mb-0">Tableau de bord de migration</h1>
        <p class="text-muted">Migration de PHP vers NestJS/Remix - <span id="lastUpdated">Mise à jour le 10 avril 2025</span></p>
      </div>
      <button id="refreshButton" class="btn btn-primary">
        <i class="bi bi-arrow-clockwise"></i> Rafraîchir
      </button>
    </div>

    <!-- Vue d'ensemble -->
    <div class="row mb-4">
      <div class="col-md-8">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-bar-chart-fill me-2"></i> Progression globale</span>
            <span class="badge bg-primary" id="globalProgressBadge">40%</span>
          </div>
          <div class="card-body">
            <div class="progress mb-3">
              <div class="progress-bar" role="progressbar" id="globalProgressBar" style="width: 40%"></div>
            </div>
            <div class="row" id="stepsProgressContainer">
              <!-- Étapes de migration -->
              <!-- Sera rempli par JavaScript -->
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card">
          <div class="card-header"><i class="bi bi-clipboard-data me-2"></i> Statistiques</div>
          <div class="card-body">
            <div class="row">
              <div class="col-6">
                <div class="stat-card">
                  <div class="value" id="totalFilesValue">0</div>
                  <div class="label">Fichiers totaux</div>
                </div>
              </div>
              <div class="col-6">
                <div class="stat-card">
                  <div class="value" id="filesMigratedValue">0</div>
                  <div class="label">Fichiers migrés</div>
                </div>
              </div>
              <div class="col-6">
                <div class="stat-card">
                  <div class="value" id="testCoverageValue">0%</div>
                  <div class="label">Couverture de tests</div>
                </div>
              </div>
              <div class="col-6">
                <div class="stat-card">
                  <div class="value" id="codeQualityValue">0%</div>
                  <div class="label">Qualité du code</div>
                </div>
              </div>
            </div>
            <hr>
            <div class="d-flex justify-content-between align-items-center">
              <span>Temps d'exécution</span>
              <span id="executionTimeValue">0s</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Onglets principaux -->
    <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="modules-tab" data-bs-toggle="tab" data-bs-target="#modules" type="button" role="tab">
          <i class="bi bi-grid-3x3-gap-fill me-2"></i> Modules
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="issues-tab" data-bs-toggle="tab" data-bs-target="#issues" type="button" role="tab">
          <i class="bi bi-exclamation-triangle-fill me-2"></i> Problèmes <span class="badge bg-danger" id="issuesCountBadge">0</span>
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="agents-tab" data-bs-toggle="tab" data-bs-target="#agents" type="button" role="tab">
          <i class="bi bi-cpu-fill me-2"></i> Agents
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="plan-tab" data-bs-toggle="tab" data-bs-target="#plan" type="button" role="tab">
          <i class="bi bi-list-check me-2"></i> Plan d'action
        </button>
      </li>
    </ul>

    <!-- Contenu des onglets -->
    <div class="tab-content" id="mainTabsContent">
      <!-- Onglet Modules -->
      <div class="tab-pane fade show active" id="modules" role="tabpanel" aria-labelledby="modules-tab">
        <div class="row" id="modulesContainer">
          <!-- Modules de l'application -->
          <!-- Sera rempli par JavaScript -->
        </div>
      </div>

      <!-- Onglet Problèmes -->
      <div class="tab-pane fade" id="issues" role="tabpanel" aria-labelledby="issues-tab">
        <div class="card">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <span>Problèmes détectés</span>
              <div>
                <select class="form-select form-select-sm" id="issueFilter">
                  <option value="all">Tous les problèmes</option>
                  <option value="error">Erreurs</option>
                  <option value="warning">Avertissements</option>
                  <option value="dependency">Dépendances</option>
                </select>
              </div>
            </div>
          </div>
          <div class="card-body issue-list" id="issuesContainer">
            <!-- Problèmes détectés -->
            <!-- Sera rempli par JavaScript -->
          </div>
        </div>
      </div>

      <!-- Onglet Agents -->
      <div class="tab-pane fade" id="agents" role="tabpanel" aria-labelledby="agents-tab">
        <div class="card mb-4">
          <div class="card-header">Graphe de dépendances des agents</div>
          <div class="card-body">
            <div id="agent-dependencies-graph"></div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">Exécutions récentes</div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-small">
                <thead>
                  <tr>
                    <th>Agent</th>
                    <th>Statut</th>
                    <th>Temps d'exécution</th>
                    <th>Éléments traités</th>
                    <th>Version</th>
                  </tr>
                </thead>
                <tbody id="agentExecutionsTable">
                  <!-- Exécutions d'agents -->
                  <!-- Sera rempli par JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Onglet Plan d'action -->
      <div class="tab-pane fade" id="plan" role="tabpanel" aria-labelledby="plan-tab">
        <div class="card mb-4">
          <div class="card-header">Prochaines étapes</div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-small">
                <thead>
                  <tr>
                    <th>Étape</th>
                    <th>Description</th>
                    <th>Statut</th>
                    <th>Priorité</th>
                    <th>Agents</th>
                  </tr>
                </thead>
                <tbody id="nextStepsTable">
                  <!-- Prochaines étapes -->
                  <!-- Sera rempli par JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cytoscape@3.23.0/dist/cytoscape.min.js"></script>
  <script>
    // Fonction pour formater le temps écoulé
    function formatTimeAgo(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;
      
      const seconds = Math.floor(diff / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);
      
      if (days > 0) return `il y a ${days} jour${days > 1 ? 's' : ''}`;
      if (hours > 0) return `il y a ${hours} heure${hours > 1 ? 's' : ''}`;
      if (minutes > 0) return `il y a ${minutes} minute${minutes > 1 ? 's' : ''}`;
      return `il y a ${seconds} seconde${seconds !== 1 ? 's' : ''}`;
    }
    
    // Fonction pour formater le temps d'exécution
    function formatExecutionTime(milliseconds) {
      if (milliseconds < 1000) return `${milliseconds}ms`;
      if (milliseconds < 60000) return `${(milliseconds / 1000).toFixed(1)}s`;
      
      const minutes = Math.floor(milliseconds / 60000);
      const seconds = ((milliseconds % 60000) / 1000).toFixed(0);
      return `${minutes}m ${seconds}s`;
    }
    
    // Charger et afficher les données du tableau de bord
    async function loadDashboardData() {
      try {
        // Afficher un indicateur de chargement
        document.getElementById('refreshButton').innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Chargement...';
        
        // Charger les données depuis l'API
        const response = await fetch('/api/status');
        const data = await response.json();
        
        // Mettre à jour la date de dernière mise à jour
        document.getElementById('lastUpdated').textContent = `Dernière mise à jour: ${new Date(data.lastUpdated).toLocaleString()}`;
        
        // Mettre à jour la progression globale
        updateGlobalProgress(data.progress);
        
        // Mettre à jour les modules
        updateModules(data.modules);
        
        // Mettre à jour les métriques
        updateMetrics(data.metrics);
        
        // Mettre à jour les problèmes
        updateIssues(data.issues);
        
        // Mettre à jour les prochaines étapes
        updateNextSteps(data.nextSteps);
        
        // Mettre à jour le graphe de dépendances des agents
        updateAgentDependenciesGraph();
        
        // Rétablir le bouton de rafraîchissement
        document.getElementById('refreshButton').innerHTML = '<i class="bi bi-arrow-clockwise"></i> Rafraîchir';
      } catch (error) {
        console.error('Erreur lors du chargement des données:', error);
        document.getElementById('refreshButton').innerHTML = '<i class="bi bi-exclamation-triangle"></i> Erreur';
      }
    }
    
    // Mettre à jour la progression globale
    function updateGlobalProgress(progress) {
      // Progression globale
      const globalProgress = progress.global || 0;
      document.getElementById('globalProgressBar').style.width = `${globalProgress}%`;
      document.getElementById('globalProgressBadge').textContent = `${globalProgress}%`;
      
      // Progression par étape
      const stepsContainer = document.getElementById('stepsProgressContainer');
      stepsContainer.innerHTML = '';
      
      Object.entries(progress).forEach(([step, percentage]) => {
        if (step === 'global') return;
        
        const stepElement = document.createElement('div');
        stepElement.className = 'col-md-6 mb-2';
        stepElement.innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-1">
            <small>${step}</small>
            <small>${percentage}%</small>
          </div>
          <div class="progress" style="height: 5px;">
            <div class="progress-bar" role="progressbar" style="width: ${percentage}%"></div>
          </div>
        `;
        
        stepsContainer.appendChild(stepElement);
      });
    }
    
    // Mettre à jour les modules
    function updateModules(modules) {
      const modulesContainer = document.getElementById('modulesContainer');
      modulesContainer.innerHTML = '';
      
      Object.values(modules).forEach(module => {
        const statusClass = module.status === 'completed' ? 'bg-success' : 
                          module.status === 'in-progress' ? 'bg-primary' : 
                          module.status === 'pending' ? 'bg-secondary' : 'bg-warning';
                          
        const statusText = module.status === 'completed' ? 'Terminé' : 
                          module.status === 'in-progress' ? 'En cours' : 
                          module.status === 'pending' ? 'En attente' : 'Bloqué';
                          
        const complexityClass = module.complexity === 'high' ? 'complexity-high' : 
                              module.complexity === 'medium' ? 'complexity-medium' : 
                              'complexity-low';
                              
        const complexityText = module.complexity === 'high' ? 'Haute' : 
                              module.complexity === 'medium' ? 'Moyenne' : 
                              'Basse';
        
        const moduleElement = document.createElement('div');
        moduleElement.className = 'col-md-4';
        moduleElement.innerHTML = `
          <div class="card module-card">
            <div class="card-body">
              <h5 class="card-title">${module.name}</h5>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="status-badge ${statusClass}">${statusText}</span>
                <small class="${complexityClass}">
                  <i class="bi bi-bar-chart-fill"></i> Complexité: ${complexityText}
                </small>
              </div>
              <div class="mt-2">
                ${module.dependencies.length > 0 ? 
                  `<div><small class="text-muted">Dépendances:</small></div>
                  <div class="mt-1">
                    ${module.dependencies.map(dep => `<span class="dependency-badge">${dep}</span>`).join('')}
                  </div>` : 
                  '<small class="text-muted">Aucune dépendance</small>'}
              </div>
            </div>
            <div class="progress">
              <div class="progress-bar" role="progressbar" style="width: ${module.progress}%"></div>
            </div>
          </div>
        `;
        
        modulesContainer.appendChild(moduleElement);
      });
    }
    
    // Mettre à jour les métriques
    function updateMetrics(metrics) {
      document.getElementById('totalFilesValue').textContent = metrics.totalFiles || 0;
      document.getElementById('filesMigratedValue').textContent = metrics.filesMigrated || 0;
      document.getElementById('testCoverageValue').textContent = `${metrics.testCoverage || 0}%`;
      document.getElementById('codeQualityValue').textContent = `${metrics.codeQuality || 0}%`;
      document.getElementById('executionTimeValue').textContent = formatExecutionTime(metrics.executionTime || 0);
    }
    
    // Mettre à jour les problèmes
    function updateIssues(issues) {
      const issuesContainer = document.getElementById('issuesContainer');
      issuesContainer.innerHTML = '';
      
      document.getElementById('issuesCountBadge').textContent = issues.length;
      
      issues.forEach(issue => {
        const iconClass = issue.severity === 'error' ? 'icon-red' : 
                          issue.severity === 'warning' ? 'icon-yellow' : 'icon-blue';
                          
        const iconType = issue.severity === 'error' ? 'exclamation-octagon-fill' : 
                        issue.severity === 'warning' ? 'exclamation-triangle-fill' : 'info-circle-fill';
        
        const issueElement = document.createElement('div');
        issueElement.className = 'd-flex align-items-start mb-3 issue-item';
        issueElement.dataset.type = issue.severity;
        issueElement.innerHTML = `
          <div class="icon-container ${iconClass}">
            <i class="bi bi-${iconType}"></i>
          </div>
          <div class="flex-grow-1">
            <div class="d-flex justify-content-between">
              <strong>${issue.file} - ${issue.agent}</strong>
              <span class="time-ago">${formatTimeAgo(issue.timestamp)}</span>
            </div>
            <p class="mb-0">${issue.message}</p>
            <div class="mt-1">
              <small class="text-muted">Type: ${issue.type}</small>
            </div>
          </div>
        `;
        
        issuesContainer.appendChild(issueElement);
      });
    }
    
    // Mettre à jour les prochaines étapes
    function updateNextSteps(nextSteps) {
      const nextStepsTable = document.getElementById('nextStepsTable');
      nextStepsTable.innerHTML = '';
      
      nextSteps.forEach(step => {
        const statusClass = step.status === 'completed' ? 'success' : 
                            step.status === 'en cours' ? 'primary' : 
                            step.status === 'bloqué' ? 'danger' : 'secondary';
                            
        const priorityClass = step.priority === 'haute' ? 'danger' : 
                              step.priority === 'moyenne' ? 'warning' : 'info';
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${step.step}</td>
          <td>${step.description}</td>
          <td><span class="badge bg-${statusClass}">${step.status}</span></td>
          <td><span class="badge bg-${priorityClass}">${step.priority}</span></td>
          <td>${step.agents.map(agent => `<span class="dependency-badge">${agent}</span>`).join(' ')}</td>
        `;
        
        nextStepsTable.appendChild(row);
      });
    }
    
    // Créer le graphe de dépendances des agents
    function updateAgentDependenciesGraph() {
      const cy = cytoscape({
        container: document.getElementById('agent-dependencies-graph'),
        elements: [
          // Nœuds (agents)
          { data: { id: 'structure', label: 'Structure' } },
          { data: { id: 'business', label: 'Business' } },
          { data: { id: 'data', label: 'Data' } },
          { data: { id: 'dependency', label: 'Dependency' } },
          { data: { id: 'quality', label: 'Quality' } },
          { data: { id: 'strategy', label: 'Strategy' } },
          { data: { id: 'assembler', label: 'Assembler' } },
          
          // Arêtes (dépendances)
          { data: { source: 'dependency', target: 'structure' } },
          { data: { source: 'quality', target: 'structure' } },
          { data: { source: 'quality', target: 'data' } },
          { data: { source: 'strategy', target: 'business' } },
          { data: { source: 'strategy', target: 'structure' } },
          { data: { source: 'strategy', target: 'data' } },
          { data: { source: 'strategy', target: 'dependency' } },
          { data: { source: 'strategy', target: 'quality' } },
          { data: { source: 'assembler', target: 'business' } },
          { data: { source: 'assembler', target: 'structure' } },
          { data: { source: 'assembler', target: 'data' } },
          { data: { source: 'assembler', target: 'dependency' } },
          { data: { source: 'assembler', target: 'quality' } },
          { data: { source: 'assembler', target: 'strategy' } }
        ],
        style: [
          {
            selector: 'node',
            style: {
              'background-color': '#2d6cd8',
              'label': 'data(label)',
              'color': '#fff',
              'text-halign': 'center',
              'text-valign': 'center',
              'font-size': '12px',
              'width': '80px',
              'height': '80px',
              'text-wrap': 'wrap'
            }
          },
          {
            selector: 'edge',
            style: {
              'width': 2,
              'line-color': '#ddd',
              'target-arrow-color': '#ddd',
              'target-arrow-shape': 'triangle',
              'curve-style': 'bezier'
            }
          }
        ],
        layout: {
          name: 'breadthfirst',
          directed: true,
          padding: 30,
          spacingFactor: 1.5
        }
      });
    }
    
    // Filtrer les problèmes
    document.getElementById('issueFilter').addEventListener('change', function() {
      const filter = this.value;
      const issues = document.querySelectorAll('.issue-item');
      
      issues.forEach(issue => {
        if (filter === 'all' || issue.dataset.type === filter) {
          issue.style.display = 'flex';
        } else {
          issue.style.display = 'none';
        }
      });
    });
    
    // Bouton de rafraîchissement
    document.getElementById('refreshButton').addEventListener('click', loadDashboardData);
    
    // Charger les données initiales
    document.addEventListener('DOMContentLoaded', loadDashboardData);
  </script>
</body>
</html>