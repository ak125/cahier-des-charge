name: Test Generation & Execution

on:
  push:
    branches: [main, develop]
    paths:
      - 'apps/backend/src/**/*'
      - 'apps/frontend/app/routes/**/*'
  pull_request:
    branches: [main, develop]
    paths:
      - 'apps/backend/src/**/*'
      - 'apps/frontend/app/routes/**/*'
  workflow_dispatch:
    inputs:
      module:
        description: 'Module spÃ©cifique Ã  tester (optionnel)'
        required: false
      type:
        description: 'Type de tests (nestjs, remix, both)'
        required: false
        default: 'both'
      auto_detect:
        description: 'Activer la dÃ©tection automatique'
        required: false
        default: 'true'
        type: boolean
      run_tests:
        description: 'ExÃ©cuter les tests aprÃ¨s gÃ©nÃ©ration'
        required: false
        default: 'true'
        type: boolean

jobs:
  generate-and-run-tests:
    name: GÃ©nÃ©rer et exÃ©cuter les tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v3
      
      - name: ğŸ”§ Configuration de Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'pnpm'
      
      - name: ğŸ“¦ Installation des dÃ©pendances
        run: |
          npm install -g pnpm
          pnpm install
      
      # Ã‰tape conditionnelle pour les modules spÃ©cifiques
      - name: ğŸ§ª GÃ©nÃ©rer les tests pour un module spÃ©cifique
        if: ${{ github.event.inputs.module != '' }}
        run: |
          ./bin/test-writer.sh --module=${{ github.event.inputs.module }} --type=${{ github.event.inputs.type }} --coverage --run-tests=${{ github.event.inputs.run_tests }}
      
      # Ã‰tape pour la dÃ©tection automatique
      - name: ğŸ§ª GÃ©nÃ©rer les tests avec dÃ©tection automatique
        if: ${{ github.event.inputs.module == '' && github.event.inputs.auto_detect == 'true' }}
        run: |
          ./bin/test-writer.sh --auto-detect --type=${{ github.event.inputs.type || 'both' }} --coverage --run-tests=${{ github.event.inputs.run_tests }}
      
      # Ã‰tape pour les fichiers modifiÃ©s dans une PR
      - name: ğŸ” DÃ©tecter les fichiers modifiÃ©s dans la PR
        if: ${{ github.event_name == 'pull_request' && github.event.inputs.module == '' && github.event.inputs.auto_detect != 'true' }}
        id: changed_files
        uses: dorny/paths-filter@v2
        with:
          filters: |
            nestjs:
              - 'apps/backend/src/**/*.ts'
              - '!apps/backend/src/**/*.spec.ts'
            remix:
              - 'apps/frontend/app/routes/**/*.tsx'
      
      # GÃ©nÃ©rer des tests pour les fichiers NestJS modifiÃ©s
      - name: ğŸ§ª GÃ©nÃ©rer les tests pour les fichiers NestJS modifiÃ©s
        if: ${{ steps.changed_files.outputs.nestjs == 'true' }}
        run: |
          # Extraire les modules modifiÃ©s
          MODIFIED_MODULES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -E 'apps/backend/src/.*/.*\.ts' | grep -v '\.spec\.ts' | sed -E 's/.*\/([^\/]+)\.service\.ts/\1/g' | sort -u)
          
          for MODULE in $MODIFIED_MODULES; do
            echo "GÃ©nÃ©ration de tests pour le module NestJS: $MODULE"
            ./bin/test-writer.sh --module=$MODULE --type=nestjs --coverage --run-tests=${{ github.event.inputs.run_tests }}
          done
      
      # GÃ©nÃ©rer des tests pour les fichiers Remix modifiÃ©s
      - name: ğŸ§ª GÃ©nÃ©rer les tests pour les fichiers Remix modifiÃ©s
        if: ${{ steps.changed_files.outputs.remix == 'true' }}
        run: |
          # Extraire les routes modifiÃ©es
          MODIFIED_ROUTES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -E 'apps/frontend/app/routes/.*\.tsx' | sed -E 's/.*\/routes\/([^\/]+)\.tsx/\1/g' | sort -u)
          
          for ROUTE in $MODIFIED_ROUTES; do
            echo "GÃ©nÃ©ration de tests pour la route Remix: $ROUTE"
            ./bin/test-writer.sh --module=$ROUTE --type=remix --coverage --run-tests=${{ github.event.inputs.run_tests }}
          done
      
      # ExÃ©cuter les tests NestJS
      - name: ğŸ§ª ExÃ©cuter les tests unitaires NestJS
        if: ${{ github.event.inputs.run_tests == 'true' }}
        run: pnpm test:unit
      
      # ExÃ©cuter les tests Remix
      - name: ğŸ§ª ExÃ©cuter les tests E2E Remix
        if: ${{ github.event.inputs.run_tests == 'true' }}
        run: pnpm test:e2e
      
      # TÃ©lÃ©charger le rapport de couverture comme artefact
      - name: ğŸ“Š Publier le rapport de couverture
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-coverage-report
          path: |
            reports/test_coverage_map.json
            coverage/
          retention-days: 14