{
  "name": "PHP Analyzer - Alertes de complexit√©",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 8 * * 1-5"
            }
          ]
        }
      },
      "id": "8e9e647f-14cf-4302-9527-180e7d1f7de1",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [
        240,
        300
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT id, path, filename, complexity, maintainability, issues_count, lines_of_code, analyzed_at\nFROM php_audit_results\nWHERE (complexity > {{$node[\"Set Alert Thresholds\"].json[\"complexityThreshold\"]}} OR issues_count > {{$node[\"Set Alert Thresholds\"].json[\"issuesThreshold\"]}})\nAND analyzed_at > NOW() - INTERVAL '1 day'\nORDER BY complexity DESC, issues_count DESC\nLIMIT 20;",
        "additionalFields": {}
      },
      "id": "738a0b21-2d4c-4b74-a9d9-eb5e92d22e39",
      "name": "Supabase - Get Complex Files",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [
        600,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "supabase-postgres",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// D√©finir les seuils d'alerte\nreturn {\n  complexityThreshold: 15,  // Seuil de complexit√© cyclomatique consid√©r√© comme √©lev√©\n  issuesThreshold: 10,      // Seuil de probl√®mes consid√©r√© comme √©lev√©\n  sendEmail: true,          // Envoyer des alertes par email\n  sendSlack: true,          // Envoyer des alertes sur Slack\n  alertTitle: \"üö® Alerte de qualit√© de code PHP\",\n  recipients: [\n    \"team-dev@example.com\",\n    \"tech-lead@example.com\"\n  ],\n  slackWebhookUrl: process.env.SLACK_WEBHOOK_PHP_QUALITY || \"\",\n  repoUrl: \"https://github.com/organization/project/blob/main/\" // URL de base du r√©pertoire GitHub\n};"
      },
      "id": "f3c2b6fc-9912-4c87-a1e3-d29f2f8f84fa",
      "name": "Set Alert Thresholds",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        420,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.length > 0 }}",
              "value2": true
            }
          ]
        }
      },
      "id": "8b5e22c5-89f9-4d8c-9f21-8e9daeeb1ddb",
      "name": "Any Complex Files?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        780,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Formater les donn√©es pour le rapport\nconst files = $input.all();\nconst thresholds = $node[\"Set Alert Thresholds\"].json;\n\n// Cr√©er un tableau HTML pour le rapport\nlet tableHtml = `\n<table style=\"border-collapse: collapse; width: 100%; margin-top: 20px;\">\n  <thead>\n    <tr style=\"background-color: #f2f2f2;\">\n      <th style=\"border: 1px solid #ddd; padding: 8px; text-align: left;\">Fichier</th>\n      <th style=\"border: 1px solid #ddd; padding: 8px; text-align: center;\">Complexit√©</th>\n      <th style=\"border: 1px solid #ddd; padding: 8px; text-align: center;\">Maintenabilit√©</th>\n      <th style=\"border: 1px solid #ddd; padding: 8px; text-align: center;\">Probl√®mes</th>\n      <th style=\"border: 1px solid #ddd; padding: 8px; text-align: center;\">Lignes</th>\n      <th style=\"border: 1px solid #ddd; padding: 8px; text-align: center;\">Analys√© le</th>\n    </tr>\n  </thead>\n  <tbody>\n`;\n\nfiles.forEach(file => {\n  // D√©finir les couleurs en fonction des seuils\n  const complexityColor = file.complexity > thresholds.complexityThreshold ? \"#f44336\" : file.complexity > 10 ? \"#ff9800\" : \"#4caf50\";\n  const maintainabilityColor = file.maintainability < 50 ? \"#f44336\" : file.maintainability < 70 ? \"#ff9800\" : \"#4caf50\";\n  const issuesColor = file.issues_count > thresholds.issuesThreshold ? \"#f44336\" : file.issues_count > 5 ? \"#ff9800\" : \"#4caf50\";\n  \n  // Formater la date\n  const date = new Date(file.analyzed_at).toLocaleString('fr-FR', {\n    year: 'numeric',\n    month: 'short',\n    day: 'numeric',\n    hour: '2-digit',\n    minute: '2-digit'\n  });\n  \n  // Construire l'URL GitHub pour le fichier\n  const githubUrl = thresholds.repoUrl + file.path;\n  \n  // Ajouter la ligne au tableau\n  tableHtml += `\n    <tr>\n      <td style=\"border: 1px solid #ddd; padding: 8px;\">\n        <a href=\"${githubUrl}\" target=\"_blank\">${file.filename}</a>\n      </td>\n      <td style=\"border: 1px solid #ddd; padding: 8px; text-align: center; background-color: ${complexityColor}; color: white; font-weight: bold;\">\n        ${file.complexity}\n      </td>\n      <td style=\"border: 1px solid #ddd; padding: 8px; text-align: center; background-color: ${maintainabilityColor}; color: white; font-weight: bold;\">\n        ${file.maintainability}\n      </td>\n      <td style=\"border: 1px solid #ddd; padding: 8px; text-align: center; background-color: ${issuesColor}; color: white; font-weight: bold;\">\n        ${file.issues_count}\n      </td>\n      <td style=\"border: 1px solid #ddd; padding: 8px; text-align: center;\">\n        ${file.lines_of_code}\n      </td>\n      <td style=\"border: 1px solid #ddd; padding: 8px; text-align: center;\">\n        ${date}\n      </td>\n    </tr>\n  `;\n});\n\ntableHtml += `\n  </tbody>\n</table>\n`;\n\n// G√©n√©rer le contenu de l'email\nconst emailHtml = `\n<div style=\"font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto;\">\n  <h2 style=\"color: #d9534f;\">${thresholds.alertTitle}</h2>\n  \n  <p>L'analyse de code PHP a d√©tect√© <strong>${files.length} fichiers</strong> d√©passant les seuils de complexit√© et/ou de probl√®mes :</p>\n  \n  <ul>\n    <li>Complexit√© cyclomatique > ${thresholds.complexityThreshold}</li>\n    <li>Nombre de probl√®mes > ${thresholds.issuesThreshold}</li>\n  </ul>\n  \n  <p>Ces fichiers n√©cessitent une attention particuli√®re pour am√©liorer la qualit√© du code et faciliter la maintenance.</p>\n  \n  ${tableHtml}\n  \n  <div style=\"margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;\">\n    <p style=\"color: #666; font-size: 0.9em;\">\n      Vous recevez cette alerte automatique car vous √™tes inscrit aux notifications de qualit√© de code.<br>\n      Pour visualiser les d√©tails complets, consultez le <a href=\"https://dashboard.example.com/php-analysis\" target=\"_blank\">Dashboard d'analyse PHP</a>.\n    </p>\n  </div>\n</div>\n`;\n\n// G√©n√©rer le contenu pour Slack\nlet slackBlocks = [\n  {\n    \"type\": \"header\",\n    \"text\": {\n      \"type\": \"plain_text\",\n      \"text\": thresholds.alertTitle,\n      \"emoji\": true\n    }\n  },\n  {\n    \"type\": \"section\",\n    \"text\": {\n      \"type\": \"mrkdwn\",\n      \"text\": `*${files.length} fichiers PHP* d√©passent les seuils de qualit√© (complexit√© > ${thresholds.complexityThreshold} ou probl√®mes > ${thresholds.issuesThreshold})`\n    }\n  },\n  {\n    \"type\": \"divider\"\n  }\n];\n\n// Ajouter les 5 premiers fichiers les plus probl√©matiques √† Slack\nfiles.slice(0, 5).forEach(file => {\n  slackBlocks.push({\n    \"type\": \"section\",\n    \"text\": {\n      \"type\": \"mrkdwn\",\n      \"text\": `*<${thresholds.repoUrl + file.path}|${file.filename}>*\\nComplexit√©: ${file.complexity} | Probl√®mes: ${file.issues_count} | Maintenabilit√©: ${file.maintainability}`\n    }\n  });\n});\n\n// Ajouter un lien vers le dashboard\nslackBlocks.push({\n  \"type\": \"section\",\n  \"text\": {\n    \"type\": \"mrkdwn\",\n    \"text\": \"Consultez le <https://dashboard.example.com/php-analysis|Dashboard d'analyse PHP> pour plus de d√©tails.\"\n  }\n});\n\nreturn {\n  emailHtml,\n  slackBlocks,\n  filesCount: files.length,\n  recipients: thresholds.recipients,\n  sendEmail: thresholds.sendEmail,\n  sendSlack: thresholds.sendSlack,\n  slackWebhookUrl: thresholds.slackWebhookUrl\n};"
      },
      "id": "34e1c4e1-c0b5-4c39-a8f6-1a90a2a7e5c9",
      "name": "Format Alert Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        960,
        240
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $node[\"Format Alert Data\"].json[\"sendEmail\"] }}",
              "value2": true
            }
          ]
        }
      },
      "id": "d77c1a12-89da-44c5-9021-e8f37e0f2d97",
      "name": "Send Email?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1180,
        240
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $node[\"Format Alert Data\"].json[\"sendSlack\"] }}",
              "value2": true
            }
          ]
        }
      },
      "id": "3f18d212-9b66-4d22-9fa8-cfc71cfe62b9",
      "name": "Send Slack?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1180,
        420
      ]
    },
    {
      "parameters": {
        "authentication": "genericCredentialType",
        "httpMethod": "POST",
        "url": "={{ $node[\"Format Alert Data\"].json[\"slackWebhookUrl\"] }}",
        "jsonParameters": true,
        "options": {},
        "bodyParametersJson": "={\n  \"blocks\": {{$node[\"Format Alert Data\"].json[\"slackBlocks\"]}}\n}"
      },
      "id": "78a20fd5-2fa4-4e3c-896c-b91d9e1d8eb7",
      "name": "Send Slack Alert",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        1400,
        420
      ]
    },
    {
      "parameters": {
        "fromEmail": "php-analyzer@example.com",
        "toEmail": "={{ $node[\"Format Alert Data\"].json[\"recipients\"].join(\",\") }}",
        "subject": "={{ $node[\"Set Alert Thresholds\"].json[\"alertTitle\"] + \": \" + $node[\"Format Alert Data\"].json[\"filesCount\"] + \" fichiers complexes d√©tect√©s\" }}",
        "html": "={{ $node[\"Format Alert Data\"].json[\"emailHtml\"] }}",
        "options": {}
      },
      "id": "f0b7b95d-d30e-4f9e-8be3-d36fad21b538",
      "name": "Send Email Alert",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 1,
      "position": [
        1400,
        240
      ]
    },
    {
      "parameters": {
        "jsCode": "// Enregistrer dans les logs n8n que nous n'avons pas trouv√© de fichiers complexes\nreturn {\n  message: \"Aucun fichier PHP complexe d√©tect√© au-dessus des seuils configur√©s.\",\n  thresholds: $node[\"Set Alert Thresholds\"].json\n};"
      },
      "id": "8d91bb2c-ca92-4b1c-b07a-f5f15a3ee4ef",
      "name": "No Files Found",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        960,
        380
      ]
    },
    {
      "parameters": {
        "triggerTimes": {
          "item": [
            {
              "mode": "custom",
              "cronExpression": "0 9 * * 1-5"
            }
          ]
        }
      },
      "id": "bd5f6a5d-5dd3-4f0a-b09e-a5d1d2343eb7",
      "name": "Weekly Trigger",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [
        240,
        560
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH weekly_stats AS (\n  SELECT \n    COUNT(*) AS total_files,\n    AVG(complexity) AS avg_complexity,\n    AVG(maintainability) AS avg_maintainability,\n    SUM(CASE WHEN complexity > 15 OR issues_count > 10 THEN 1 ELSE 0 END) AS high_risk_files,\n    SUM(issues_count) AS total_issues\n  FROM php_audit_results\n  WHERE analyzed_at > NOW() - INTERVAL '7 days'\n),\nprevious_week AS (\n  SELECT \n    COUNT(*) AS total_files,\n    AVG(complexity) AS avg_complexity,\n    AVG(maintenability) AS avg_maintenability,\n    SUM(CASE WHEN complexity > 15 OR issues_count > 10 THEN 1 ELSE 0 END) AS high_risk_files,\n    SUM(issues_count) AS total_issues\n  FROM php_audit_results\n  WHERE analyzed_at BETWEEN NOW() - INTERVAL '14 days' AND NOW() - INTERVAL '7 days'\n),\ntop_complex_files AS (\n  SELECT \n    path, \n    filename, \n    complexity, \n    maintainability, \n    issues_count, \n    lines_of_code\n  FROM php_audit_results\n  WHERE analyzed_at > NOW() - INTERVAL '7 days'\n  ORDER BY complexity DESC, issues_count DESC\n  LIMIT 5\n)\nSELECT \n  w.total_files,\n  w.avg_complexity,\n  w.avg_maintainability,\n  w.high_risk_files,\n  w.total_issues,\n  p.total_files AS prev_total_files,\n  p.avg_complexity AS prev_avg_complexity,\n  p.avg_maintenability AS prev_avg_maintainability,\n  p.high_risk_files AS prev_high_risk_files,\n  p.total_issues AS prev_total_issues,\n  json_agg(t.*) AS top_files\nFROM weekly_stats w\nCROSS JOIN previous_week p\nCROSS JOIN (SELECT * FROM top_complex_files) t\nGROUP BY w.total_files, w.avg_complexity, w.avg_maintainability, w.high_risk_files, w.total_issues,\n         p.total_files, p.avg_complexity, p.avg_maintenability, p.high_risk_files, p.total_issues;",
        "additionalFields": {}
      },
      "id": "bf90a6c0-2fb1-49e6-95e9-12f3c752e9f1",
      "name": "Supabase - Weekly Stats",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [
        420,
        560
      ],
      "credentials": {
        "postgres": {
          "id": "supabase-postgres",
          "name": "Supabase Postgres"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Formater les donn√©es pour le rapport hebdomadaire\nconst data = $input.item.json;\nconst thresholds = $node[\"Set Alert Thresholds\"].json;\n\n// R√©cup√©rer les statistiques\nlet stats = {};\nif (data && data.length > 0) {\n  stats = data[0];\n} else {\n  // Valeurs par d√©faut si aucune donn√©e n'est disponible\n  stats = {\n    total_files: 0,\n    avg_complexity: 0,\n    avg_maintainability: 0,\n    high_risk_files: 0,\n    total_issues: 0,\n    prev_total_files: 0,\n    prev_avg_complexity: 0,\n    prev_avg_maintainability: 0,\n    prev_high_risk_files: 0,\n    prev_total_issues: 0,\n    top_files: []\n  };\n}\n\n// Calculer les variations par rapport √† la semaine pr√©c√©dente\nconst percentChange = (current, previous) => {\n  if (previous === 0) return 0;\n  return ((current - previous) / previous) * 100;\n};\n\nconst complexityChange = percentChange(stats.avg_complexity, stats.prev_avg_complexity);\nconst maintainabilityChange = percentChange(stats.avg_maintainability, stats.prev_avg_maintainability);\nconst highRiskChange = percentChange(stats.high_risk_files, stats.prev_high_risk_files);\nconst issuesChange = percentChange(stats.total_issues, stats.prev_total_issues);\n\n// Fonctions pour g√©n√©rer des fl√®ches de tendance\nconst getTrendArrow = (change, inverse = false) => {\n  if (change === 0) return \"‚Üí\";\n  if (!inverse) {\n    return change > 0 ? \"‚ÜóÔ∏è\" : \"‚ÜòÔ∏è\";\n  } else {\n    return change > 0 ? \"‚ÜòÔ∏è\" : \"‚ÜóÔ∏è\";\n  }\n};\n\nconst getTrendColor = (change, inverse = false) => {\n  if (change === 0) return \"#888888\";\n  if (!inverse) {\n    return change > 0 ? \"#f44336\" : \"#4caf50\";\n  } else {\n    return change > 0 ? \"#4caf50\" : \"#f44336\";\n  }\n};\n\n// Formater les tableaux pour les fichiers les plus complexes\nlet topFilesHtml = '';\nif (stats.top_files && stats.top_files.length > 0) {\n  topFilesHtml = '<table style=\"border-collapse: collapse; width: 100%; margin-top: 15px;\">';\n  topFilesHtml += `\n    <thead>\n      <tr style=\"background-color: #f2f2f2;\">\n        <th style=\"border: 1px solid #ddd; padding: 8px; text-align: left;\">Fichier</th>\n        <th style=\"border: 1px solid #ddd; padding: 8px; text-align: center;\">Complexit√©</th>\n        <th style=\"border: 1px solid #ddd; padding: 8px; text-align: center;\">Maintenabilit√©</th>\n        <th style=\"border: 1px solid #ddd; padding: 8px; text-align: center;\">Probl√®mes</th>\n      </tr>\n    </thead>\n    <tbody>\n  `;\n  \n  stats.top_files.forEach(file => {\n    const complexityColor = file.complexity > thresholds.complexityThreshold ? \"#f44336\" : file.complexity > 10 ? \"#ff9800\" : \"#4caf50\";\n    const maintainabilityColor = file.maintainability < 50 ? \"#f44336\" : file.maintainability < 70 ? \"#ff9800\" : \"#4caf50\";\n    \n    topFilesHtml += `\n      <tr>\n        <td style=\"border: 1px solid #ddd; padding: 8px;\">\n          <a href=\"${thresholds.repoUrl + file.path}\" target=\"_blank\">${file.filename}</a>\n        </td>\n        <td style=\"border: 1px solid #ddd; padding: 8px; text-align: center; background-color: ${complexityColor}; color: white;\">\n          ${file.complexity.toFixed(1)}\n        </td>\n        <td style=\"border: 1px solid #ddd; padding: 8px; text-align: center; background-color: ${maintainabilityColor}; color: white;\">\n          ${file.maintainability.toFixed(1)}\n        </td>\n        <td style=\"border: 1px solid #ddd; padding: 8px; text-align: center;\">\n          ${file.issues_count}\n        </td>\n      </tr>\n    `;\n  });\n  \n  topFilesHtml += '</tbody></table>';\n}\n\n// G√©n√©rer le contenu de l'email\nconst weeklyReportHtml = `\n<div style=\"font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto;\">\n  <h2 style=\"color: #1976d2;\">üìä Rapport hebdomadaire d'analyse PHP - Semaine ${new Date().toISOString().slice(0, 10)}</h2>\n  \n  <div style=\"display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px;\">\n    <!-- Statistiques de la semaine -->\n    <div style=\"flex: 1; min-width: 200px; background-color: #f9f9f9; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);\">\n      <h3 style=\"margin-top: 0; color: #333;\">Fichiers analys√©s</h3>\n      <div style=\"font-size: 24px; font-weight: bold; margin-bottom: 5px;\">${stats.total_files}</div>\n      <div style=\"color: ${getTrendColor(percentChange(stats.total_files, stats.prev_total_files))}\">\n        ${getTrendArrow(percentChange(stats.total_files, stats.prev_total_files))} ${Math.abs(percentChange(stats.total_files, stats.prev_total_files)).toFixed(1)}%\n      </div>\n    </div>\n    \n    <div style=\"flex: 1; min-width: 200px; background-color: #f9f9f9; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);\">\n      <h3 style=\"margin-top: 0; color: #333;\">Complexit√© moyenne</h3>\n      <div style=\"font-size: 24px; font-weight: bold; margin-bottom: 5px;\">${stats.avg_complexity.toFixed(1)}</div>\n      <div style=\"color: ${getTrendColor(complexityChange, true)}\">\n        ${getTrendArrow(complexityChange, true)} ${Math.abs(complexityChange).toFixed(1)}%\n      </div>\n    </div>\n    \n    <div style=\"flex: 1; min-width: 200px; background-color: #f9f9f9; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);\">\n      <h3 style=\"margin-top: 0; color: #333;\">Maintenabilit√© moyenne</h3>\n      <div style=\"font-size: 24px; font-weight: bold; margin-bottom: 5px;\">${stats.avg_maintainability.toFixed(1)}</div>\n      <div style=\"color: ${getTrendColor(maintainabilityChange)}\">\n        ${getTrendArrow(maintainabilityChange)} ${Math.abs(maintainabilityChange).toFixed(1)}%\n      </div>\n    </div>\n    \n    <div style=\"flex: 1; min-width: 200px; background-color: #f9f9f9; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);\">\n      <h3 style=\"margin-top: 0; color: #333;\">Fichiers √† haut risque</h3>\n      <div style=\"font-size: 24px; font-weight: bold; margin-bottom: 5px;\">${stats.high_risk_files}</div>\n      <div style=\"color: ${getTrendColor(highRiskChange, true)}\">\n        ${getTrendArrow(highRiskChange, true)} ${Math.abs(highRiskChange).toFixed(1)}%\n      </div>\n    </div>\n  </div>\n  \n  <h3 style=\"color: #333; border-bottom: 1px solid #ddd; padding-bottom: 10px;\">Top 5 des fichiers les plus complexes</h3>\n  ${topFilesHtml}\n  \n  <div style=\"margin-top: 30px; background-color: #f5f5f5; padding: 15px; border-radius: 8px;\">\n    <h3 style=\"margin-top: 0; color: #333;\">Recommandations</h3>\n    <ul style=\"margin-bottom: 0;\">\n      ${stats.high_risk_files > 5 ? '<li>R√©duisez le nombre de fichiers √† haut risque (actuellement ' + stats.high_risk_files + ')</li>' : ''}\n      ${stats.avg_complexity > 10 ? '<li>Travaillez sur la simplification des modules complexes</li>' : ''}\n      ${stats.avg_maintainability < 70 ? '<li>Am√©liorez la maintenabilit√© du code en r√©duisant la complexit√© et en ajoutant des commentaires</li>' : ''}\n      <li>Consultez le <a href=\"https://dashboard.example.com/php-analysis\" target=\"_blank\">Dashboard d'analyse PHP</a> pour des informations d√©taill√©es</li>\n    </ul>\n  </div>\n  \n  <div style=\"margin-top: 30px; font-size: 0.9em; color: #666; text-align: center;\">\n    <p>Ce rapport est g√©n√©r√© automatiquement par le pipeline MCP PHP Analyzer.</p>\n  </div>\n</div>\n`;\n\n// Pr√©paration des blocs Slack pour le rapport hebdomadaire\nconst slackBlocks = [\n  {\n    \"type\": \"header\",\n    \"text\": {\n      \"type\": \"plain_text\",\n      \"text\": \"üìä Rapport hebdomadaire d'analyse PHP\",\n      \"emoji\": true\n    }\n  },\n  {\n    \"type\": \"section\",\n    \"fields\": [\n      {\n        \"type\": \"mrkdwn\",\n        \"text\": `*Fichiers analys√©s:*\\n${stats.total_files} ${getTrendArrow(percentChange(stats.total_files, stats.prev_total_files))} ${Math.abs(percentChange(stats.total_files, stats.prev_total_files)).toFixed(1)}%`\n      },\n      {\n        \"type\": \"mrkdwn\",\n        \"text\": `*Complexit√© moyenne:*\\n${stats.avg_complexity.toFixed(1)} ${getTrendArrow(complexityChange, true)} ${Math.abs(complexityChange).toFixed(1)}%`\n      }\n    ]\n  },\n  {\n    \"type\": \"section\",\n    \"fields\": [\n      {\n        \"type\": \"mrkdwn\",\n        \"text\": `*Maintenabilit√© moyenne:*\\n${stats.avg_maintainability.toFixed(1)} ${getTrendArrow(maintainabilityChange)} ${Math.abs(maintainabilityChange).toFixed(1)}%`\n      },\n      {\n        \"type\": \"mrkdwn\",\n        \"text\": `*Fichiers √† haut risque:*\\n${stats.high_risk_files} ${getTrendArrow(highRiskChange, true)} ${Math.abs(highRiskChange).toFixed(1)}%`\n      }\n    ]\n  },\n  {\n    \"type\": \"divider\"\n  },\n  {\n    \"type\": \"section\",\n    \"text\": {\n      \"type\": \"mrkdwn\",\n      \"text\": \"*Top fichiers les plus complexes:*\"\n    }\n  }\n];\n\n// Ajouter les fichiers les plus complexes aux blocs Slack\nif (stats.top_files && stats.top_files.length > 0) {\n  stats.top_files.forEach(file => {\n    slackBlocks.push({\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": `‚Ä¢ *<${thresholds.repoUrl + file.path}|${file.filename}>* - Complexit√©: ${file.complexity.toFixed(1)} | Maintenabilit√©: ${file.maintainability.toFixed(1)}`\n      }\n    });\n  });\n}\n\nslackBlocks.push({\n  \"type\": \"context\",\n  \"elements\": [\n    {\n      \"type\": \"mrkdwn\",\n      \"text\": \"Consultez le <https://dashboard.example.com/php-analysis|Dashboard d'analyse PHP> pour plus de d√©tails.\"\n    }\n  ]\n});\n\nreturn {\n  weeklyReportHtml,\n  slackBlocks,\n  recipients: thresholds.recipients,\n  sendEmail: thresholds.sendEmail,\n  sendSlack: thresholds.sendSlack,\n  slackWebhookUrl: thresholds.slackWebhookUrl\n};"
      },
      "id": "8a6c2a75-5cd1-4fb5-9c0f-d1f7fc0d1234",
      "name": "Format Weekly Report",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        600,
        560
      ]
    },
    {
      "parameters": {
        "fromEmail": "php-analyzer@example.com",
        "toEmail": "={{ $node[\"Format Weekly Report\"].json[\"recipients\"].join(\",\") }}",
        "subject": "üìä Rapport hebdomadaire d'analyse PHP - {{ $today | formatDate('DD/MM/YYYY') }}",
        "html": "={{ $node[\"Format Weekly Report\"].json[\"weeklyReportHtml\"] }}",
        "options": {}
      },
      "id": "03a1fd67-e4b5-45a2-8b9e-2c07c5f31a55",
      "name": "Send Weekly Report Email",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 1,
      "position": [
        780,
        500
      ]
    },
    {
      "parameters": {
        "authentication": "genericCredentialType",
        "httpMethod": "POST",
        "url": "={{ $node[\"Format Weekly Report\"].json[\"slackWebhookUrl\"] }}",
        "jsonParameters": true,
        "options": {},
        "bodyParametersJson": "={\n  \"blocks\": {{$node[\"Format Weekly Report\"].json[\"slackBlocks\"]}}\n}"
      },
      "id": "3267f25b-4bca-40c3-a80c-c5b2fc0d54a1",
      "name": "Send Weekly Report Slack",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        780,
        620
      ]
    }
  ],
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Set Alert Thresholds",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase - Get Complex Files": {
      "main": [
        [
          {
            "node": "Any Complex Files?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Alert Thresholds": {
      "main": [
        [
          {
            "node": "Supabase - Get Complex Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Any Complex Files?": {
      "main": [
        [
          {
            "node": "Format Alert Data",
            "type": "main",
            "index": 0
          },
          {
            "node": "No Files Found",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Alert Data": {
      "main": [
        [
          {
            "node": "Send Email?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send Slack?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Email?": {
      "main": [
        [
          {
            "node": "Send Email Alert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Slack?": {
      "main": [
        [
          {
            "node": "Send Slack Alert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Weekly Trigger": {
      "main": [
        [
          {
            "node": "Supabase - Weekly Stats",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase - Weekly Stats": {
      "main": [
        [
          {
            "node": "Format Weekly Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Weekly Report": {
      "main": [
        [
          {
            "node": "Send Weekly Report Email",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send Weekly Report Slack",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveExecutionProgress": true,
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": ""
  },
  "staticData": null,
  "tags": [
    {
      "id": 1,
      "name": "php-analyzer"
    },
    {
      "id": 2,
      "name": "alertes"
    }
  ],
  "pinData": {},
  "versionId": "65ad0b85-60ec-4823-a30d-a0e4cc5e8d77",
  "meta": {
    "instanceId": "123456-7890-abc-def-123456789012"
  }
}