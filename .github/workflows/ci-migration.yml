name: CI Migration Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  build-test-validate:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'

    - name: Installation des d√©pendances
      run: npm ci || npm install

    - name: Lint du code
      run: npm run lint

    - name: V√©rification TypeScript
      run: npx tsc --noEmit

    - name: Build du projet
      run: npm run build --workspaces

    - name: Tests unitaires
      run: npm run test:backend && npm run test:frontend

    - name: Tests end-to-end
      run: npm run test:e2e

    - name: V√©rification des migrations Prisma
      run: npx prisma validate && npx prisma migrate diff --from-schema-datamodel prisma/schema.prisma --to-migrations-directory prisma/migrations --exit-code

    - name: Audit de s√©curit√©
      run: npm audit --production --audit-level=high

    - name: Notify on Success
      if: success()
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { issue, repo } = context;
          if (context.payload.pull_request) {
            github.rest.issues.createComment({
              issue_number: issue.number,
              owner: repo.owner,
              repo: repo.repo,
              body: '‚úÖ CI Pipeline a r√©ussi! Tous les tests et v√©rifications sont pass√©s.'
            });
            github.rest.issues.addLabels({
              issue_number: issue.number,
              owner: repo.owner,
              repo: repo.repo,
              labels: ['ci:passed']
            });
          }

    - name: Notify on Failure
      if: failure()
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { issue, repo } = context;
          if (context.payload.pull_request) {
            github.rest.issues.createComment({
              issue_number: issue.number,
              owner: repo.owner,
              repo: repo.repo,
              body: '‚ùå CI Pipeline a √©chou√©! Veuillez consulter les logs pour plus de d√©tails.'
            });
            github.rest.issues.addLabels({
              issue_number: issue.number,
              owner: repo.owner,
              repo: repo.repo,
              labels: ['ci:failed']
            });

name: CI - V√©rification Migration MCP

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'app/routes/**'
      - 'docs/**'
      - 'tests/**'

jobs:
  verify-migration:
    if: contains(github.head_ref, 'migration/')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'pnpm'
          
      - name: Install pnpm
        run: npm install -g pnpm
        
      - name: Install dependencies
        run: pnpm install
        
      - name: V√©rifier les types TypeScript
        run: pnpm tsc --noEmit
        
      - name: Ex√©cuter les tests
        run: pnpm test -- --selectFiles=$(echo ${{ github.event.pull_request.title }} | sed -n 's/.*‚Üí \(.*\)/\1/p')
        
      - name: Linter
        run: pnpm lint app/routes/
        
      - name: V√©rification de la structure MCP
        run: |
          echo "V√©rification de la structure MCP pour la migration..."
          
          # Extraire le nom du fichier cible depuis le titre de la PR
          TARGET_FILE=$(echo ${{ github.event.pull_request.title }} | sed -n 's/.*‚Üí \(.*\)/\1/p')
          BASE_NAME=$(basename $TARGET_FILE .tsx)
          
          # V√©rifier la pr√©sence des fichiers requis
          MISSING_FILES=""
          
          # V√©rifier les fichiers de route
          [ ! -f "app/routes/$BASE_NAME.tsx" ] && MISSING_FILES="$MISSING_FILES\n- app/routes/$BASE_NAME.tsx"
          [ ! -f "app/routes/$BASE_NAME.loader.ts" ] && MISSING_FILES="$MISSING_FILES\n- app/routes/$BASE_NAME.loader.ts"
          
          # V√©rifier les fichiers de documentation
          [ ! -f "docs/$BASE_NAME.audit.md" ] && MISSING_FILES="$MISSING_FILES\n- docs/$BASE_NAME.audit.md"
          [ ! -f "docs/$BASE_NAME.final.md" ] && MISSING_FILES="$MISSING_FILES\n- docs/$BASE_NAME.final.md"
          [ ! -f "docs/$BASE_NAME.verification_report.json" ] && MISSING_FILES="$MISSING_FILES\n- docs/$BASE_NAME.verification_report.json"
          
          # V√©rifier les tests
          [ ! -f "tests/routes/$BASE_NAME.test.ts" ] && MISSING_FILES="$MISSING_FILES\n- tests/routes/$BASE_NAME.test.ts"
          
          # Afficher les r√©sultats
          if [ ! -z "$MISSING_FILES" ]; then
            echo "::error::Fichiers manquants dans la migration MCP:$MISSING_FILES"
            exit 1
          else
            echo "‚úÖ Tous les fichiers requis sont pr√©sents pour la migration MCP."
          fi
          
      - name: V√©rifier la qualit√© du code avec MCP Verifier
        run: |
          # Extraire le nom du fichier cible depuis le titre de la PR
          TARGET_FILE=$(echo ${{ github.event.pull_request.title }} | sed -n 's/.*‚Üí \(.*\)/\1/p')
          BASE_NAME=$(basename $TARGET_FILE .tsx)
          
          # Ex√©cuter MCP Verifier
          pnpm mcp-verify $BASE_NAME --type-check --add-tags
        
      - name: Commenter les r√©sultats sur la PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Extraire le nom du fichier cible depuis le titre de la PR
            const prTitle = context.payload.pull_request.title;
            const targetFileMatch = prTitle.match(/‚Üí\s*([^\s]+)/);
            
            if (!targetFileMatch) {
              console.log('Impossible de d√©terminer le fichier cible √† partir du titre de la PR');
              return;
            }
            
            const targetFile = targetFileMatch[1];
            const baseName = path.basename(targetFile, path.extname(targetFile));
            
            // Lire le rapport de v√©rification
            let verificationReport;
            try {
              const reportPath = `docs/${baseName}.verification_report.json`;
              verificationReport = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
            } catch (error) {
              console.log(`Erreur lors de la lecture du rapport de v√©rification: ${error.message}`);
              return;
            }
            
            // Cr√©er un r√©sum√© du rapport
            let comment = `## üîç R√©sultats de la v√©rification MCP\n\n`;
            
            // Statut global
            const statusEmoji = {
              'success': '‚úÖ',
              'warning': '‚ö†Ô∏è',
              'error': '‚ùå',
              'not-found': '‚ùì'
            };
            
            comment += `### Statut: ${statusEmoji[verificationReport.status] || 'üîÑ'} ${verificationReport.status.toUpperCase()}\n\n`;
            
            // Tags
            if (verificationReport.tags && verificationReport.tags.length > 0) {
              comment += `### Tags\n`;
              verificationReport.tags.forEach(tag => {
                comment += `- ${tag}\n`;
              });
              comment += '\n';
            }
            
            // R√©sultats d√©taill√©s
            comment += `### D√©tails\n\n`;
            comment += `| Fichier | Type | Statut | Messages |\n`;
            comment += `|---------|------|--------|----------|\n`;
            
            verificationReport.results.forEach(result => {
              const fileName = result.file ? path.basename(result.file) : `${baseName}${result.fileType}`;
              const status = `${statusEmoji[result.status] || 'üîÑ'} ${result.status}`;
              const messages = result.messages.length > 0 ? result.messages.join('<br>') : 'Aucun probl√®me';
              
              comment += `| \`${fileName}\` | ${result.fileType} | ${status} | ${messages} |\n`;
            });
            
            // Ajouter le commentaire √† la PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });