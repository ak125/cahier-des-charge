{
  "id": "audit-quality-metrics",
  "name": "Audit Quality Metrics",
  "active": true,
  "nodes": [
    {
      "parameters": {
        "triggerTimes": {
          "item": [
            {
              "mode": "everyX",
              "value": 24,
              "unit": "hours"
            }
          ]
        }
      },
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "position": [100, 200]
    },
    {
      "parameters": {
        "functionCode": "// Ex√©cute l'analyseur de qualit√© des audits\nconst { spawnSync } = require('child_process');\n\nconst result = spawnSync('npx', ['ts-node', '/workspaces/cahier-des-charge/utils/audit-quality-analyzer.ts', '--verbose'], {\n  encoding: 'utf8',\n  cwd: '/workspaces/cahier-des-charge'\n});\n\nif (result.error) {\n  throw new Error(`Erreur d'ex√©cution: ${result.error.message}`);\n}\n\nlet qualityReport;\ntry {\n  qualityReport = require('/workspaces/cahier-des-charge/reports/audit_quality_metrics.json');\n} catch (err) {\n  throw new Error(`Impossible de lire le rapport de qualit√©: ${err.message}`);\n}\n\nreturn {\n  json: {\n    qualityReport,\n    timestamp: new Date().toISOString(),\n    summary: {\n      totalAudits: qualityReport.totalAudits,\n      averageCompleteness: qualityReport.averageMetrics.completeness.toFixed(1) + '%',\n      averageConsistency: qualityReport.averageMetrics.consistency.toFixed(1) + '%',\n      averageMigrationReadiness: qualityReport.averageMetrics.migrationReadiness.toFixed(1) + '%',\n      improvingAudits: qualityReport.trends.improving.length,\n      decliningAudits: qualityReport.trends.declining.length,\n      priorityAudits: qualityReport.recommendations.priority.length\n    }\n  }\n};"
      },
      "name": "Run Quality Analysis",
      "type": "n8n-nodes-base.function",
      "position": [300, 200]
    },
    {
      "parameters": {
        "chatId": "{{ $env.NOTIFICATION_CHAT_ID }}",
        "text": "üìä *Rapport de qualit√© des audits*\n\n*R√©sum√©:*\n- Total des audits: {{ $json.summary.totalAudits }}\n- Compl√©tude moyenne: {{ $json.summary.averageCompleteness }}\n- Coh√©rence moyenne: {{ $json.summary.averageConsistency }}\n- Pr√©paration √† la migration: {{ $json.summary.averageMigrationReadiness }}\n\n*Tendances:*\n- Audits en am√©lioration: {{ $json.summary.improvingAudits }}\n- Audits en d√©clin: {{ $json.summary.decliningAudits }}\n- Audits prioritaires: {{ $json.summary.priorityAudits }}\n\n[Voir le tableau de bord](http://localhost:3000/audit-dashboard)",
        "additionalFields": {
          "parseMode": "Markdown",
          "disableNotification": false
        }
      },
      "name": "Send Quality Report",
      "type": "n8n-nodes-base.telegram",
      "position": [500, 200]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.summary.priorityAudits }}",
              "operation": "larger",
              "value2": 3
            }
          ]
        }
      },
      "name": "Priority Audits?",
      "type": "n8n-nodes-base.if",
      "position": [700, 200]
    },
    {
      "parameters": {
        "chatId": "{{ $env.NOTIFICATION_CHAT_ID }}",
        "text": "‚ö†Ô∏è *Attention: {{ $json.summary.priorityAudits }} audits prioritaires n√©cessitent des am√©liorations*\n\nVoici la liste des audits √† am√©liorer en priorit√©:\n{% for slug in $json.qualityReport.recommendations.priority %}{% if loop.index <= 5 %}\n- `{{ slug }}`{% endif %}{% endfor %}\n{% if $json.qualityReport.recommendations.priority.length > 5 %}\n...et {{ $json.qualityReport.recommendations.priority.length - 5 }} autres.\n{% endif %}\n\nMerci de consulter le tableau de bord pour plus de d√©tails:\n[Voir le dashboard](http://localhost:3000/audit-dashboard)",
        "additionalFields": {
          "parseMode": "Markdown",
          "disableNotification": false
        }
      },
      "name": "Send Priority Alert",
      "type": "n8n-nodes-base.telegram",
      "position": [900, 120]
    },
    {
      "parameters": {
        "keepOnlySet": true,
        "values": {
          "string": [
            {
              "name": "totalAudits",
              "value": "={{ $json.summary.totalAudits }}"
            },
            {
              "name": "averageCompleteness",
              "value": "={{ $json.summary.averageCompleteness }}"
            },
            {
              "name": "averageConsistency",
              "value": "={{ $json.summary.averageConsistency }}"
            },
            {
              "name": "averageMigrationReadiness",
              "value": "={{ $json.summary.averageMigrationReadiness }}"
            },
            {
              "name": "improvingAudits",
              "value": "={{ $json.summary.improvingAudits }}"
            },
            {
              "name": "decliningAudits",
              "value": "={{ $json.summary.decliningAudits }}"
            },
            {
              "name": "priorityAudits",
              "value": "={{ $json.summary.priorityAudits }}"
            },
            {
              "name": "timestamp",
              "value": "={{ $json.timestamp }}"
            }
          ]
        },
        "options": {}
      },
      "name": "Prepare Metrics",
      "type": "n8n-nodes-base.set",
      "position": [900, 280]
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": "public",
        "table": "audit_metrics",
        "primaryKey": "id",
        "columns": "timestamp,total_audits,completeness,consistency,migration_readiness,improving,declining,priority",
        "additionalFields": {}
      },
      "name": "Save to Database",
      "type": "n8n-nodes-base.postgres",
      "position": [1100, 280]
    }
  ],
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Run Quality Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Run Quality Analysis": {
      "main": [
        [
          {
            "node": "Send Quality Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Quality Report": {
      "main": [
        [
          {
            "node": "Priority Audits?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Priority Audits?": {
      "main": [
        [
          {
            "node": "Send Priority Alert",
            "type": "main",
            "index": 0
          },
          {
            "node": "Prepare Metrics",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Metrics": {
      "main": [
        [
          {
            "node": "Save to Database",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "meta": {
    "templateCredsSetupCompleted": true
  }
}
