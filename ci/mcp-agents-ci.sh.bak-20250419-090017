#!/bin/bash
# Script CI/CD pour les agents MCP
# Ã€ utiliser dans les pipelines d'intÃ©gration continue
# Date: 19 avril 2025

echo "ðŸš€ Pipeline CI/CD pour les agents MCP"
echo "===================================="

# Variables
WORKSPACE_ROOT="/workspaces/cahier-des-charge"
REPORT_DIR="${WORKSPACE_ROOT}/reports/ci-agents-$(date +%Y%m%d-%H%M%S)"

# CrÃ©ation du rÃ©pertoire de rapport
mkdir -p "$REPORT_DIR"
CI_LOG="${REPORT_DIR}/ci.log"

# Fonction de journalisation
log() {
  local message="$1"
  echo "$message"
  echo "$(date +"%Y-%m-%d %H:%M:%S") - $message" >> "$CI_LOG"
}

# Ã‰tape 1: VÃ©rifier la prÃ©sence des scripts essentiels
log "ðŸ” VÃ©rification des scripts essentiels..."

# Liste adaptÃ©e des scripts disponibles dans notre environnement
REQUIRED_SCRIPTS=(
  "${WORKSPACE_ROOT}/clean-agents-duplicates.sh"
  "${WORKSPACE_ROOT}/sync-mcp-agents.sh"
  "${WORKSPACE_ROOT}/integrate-orphan-agents.sh"
)

MISSING_SCRIPTS=0
for script in "${REQUIRED_SCRIPTS[@]}"; do
  if [ ! -f "$script" ]; then
    log "âŒ Script non trouvÃ©: $script"
    MISSING_SCRIPTS=$((MISSING_SCRIPTS + 1))
  elif [ ! -x "$script" ]; then
    log "âš ï¸  Script non exÃ©cutable, ajout des permissions: $script"
    chmod +x "$script"
  else
    log "âœ“ Script disponible: $(basename "$script")"
  fi
done

if [ $MISSING_SCRIPTS -gt 0 ]; then
  log "âŒ $MISSING_SCRIPTS scripts requis sont manquants"
  exit 1
fi

log "âœ… Tous les scripts essentiels sont disponibles"

# Ã‰tape 2: Synchroniser les doublons d'agents si le script existe
log "ðŸ”„ Synchronisation des agents..."
if [ -x "${WORKSPACE_ROOT}/sync-mcp-agents.sh" ]; then
  "${WORKSPACE_ROOT}/sync-mcp-agents.sh" > "${REPORT_DIR}/sync.log" 2>&1
  SYNC_STATUS=$?

  if [ $SYNC_STATUS -ne 0 ]; then
    log "âš ï¸ Avertissement: La synchronisation a rencontrÃ© des problÃ¨mes, voir ${REPORT_DIR}/sync.log"
  else
    log "âœ… Synchronisation rÃ©ussie"
  fi
else
  log "âš ï¸ Script de synchronisation non exÃ©cutable, Ã©tape ignorÃ©e"
fi

# Ã‰tape 3: CrÃ©er un tsconfig temporaire spÃ©cifique pour les tests
log "ðŸ“ CrÃ©ation d'une configuration TypeScript temporaire..."

TEMP_TSCONFIG="${REPORT_DIR}/tsconfig.test.json"
cat > "$TEMP_TSCONFIG" << EOL
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "CommonJS",
    "moduleResolution": "node",
    "esModuleInterop": true,
    "strict": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "outDir": "${REPORT_DIR}/dist",
    "resolveJsonModule": true
  },
  "include": [
    "${REPORT_DIR}/*.ts"
  ],
  "exclude": [
    "node_modules"
  ]
}
EOL

log "âœ… Configuration TypeScript temporaire crÃ©Ã©e: $TEMP_TSCONFIG"

# Ã‰tape 4: Utiliser notre script de test JavaScript simple qui fonctionne dÃ©jÃ 
log "ðŸ§ª Test de l'agent htaccess-router-analyzer..."

# CrÃ©er une copie du script de test JavaScript dans le rÃ©pertoire de rapport
AGENT_TEST_SCRIPT="${REPORT_DIR}/test-agent.js"

cat > "$AGENT_TEST_SCRIPT" << EOL
/**
 * Test pour l'agent HtaccessRouterAnalyzer
 * Ce script teste si l'agent est correctement implÃ©mentÃ© et fonctionnel
 */

const path = require('path');
const fs = require('fs');

// Chemins absolus pour Ã©viter les erreurs de chemin relatif
const basePath = '${WORKSPACE_ROOT}';
const possiblePaths = [
  'packages/mcp-agents/business/analyzers/htaccess-router-analyzer/index.ts',
  'packages/mcp-agents/business/analyzers/htaccess-router-analyzer/htaccess-router-analyzer.ts',
  'packages/mcp-agents/business/analyzers/htaccess-router-analyzer.ts',
  'packages/mcp-agents/analyzers/htaccess-router-analyzer/index.ts'
];

console.log('VÃ©rification des chemins possibles pour l\\'agent:');

let agentPath = '';
for (const relativePath of possiblePaths) {
  const fullPath = path.join(basePath, relativePath);
  const exists = fs.existsSync(fullPath);
  console.log(\`- \${relativePath}: \${exists ? 'Existe âœ“' : 'N\\'existe pas âœ—'}\`);
  
  if (exists && !agentPath) {
    agentPath = fullPath;
  }
}

if (!agentPath) {
  console.error('âŒ Aucun fichier d\\'agent trouvÃ©');
  process.exit(1);
}

console.log(\`âœ… Agent trouvÃ© Ã : \${agentPath}\`);

// Examiner le contenu du fichier agent pour vÃ©rifier qu'il respecte l'interface
if (agentPath && fs.existsSync(agentPath)) {
  console.log('\\nAnalyse du fichier agent:');
  const content = fs.readFileSync(agentPath, 'utf8');
  
  // VÃ©rifier si le fichier contient certaines signatures importantes
  const hasExport = content.includes('export ');
  const hasClass = content.includes('class ');
  const hasMetadata = content.includes('metadata');
  const hasEvents = content.includes('events');
  const hasInitialize = content.includes('initialize');
  const hasExecute = content.includes('execute');
  const hasValidate = content.includes('validate');
  const hasStop = content.includes('stop');
  
  console.log(\`- Export prÃ©sent: \${hasExport ? 'Oui âœ“' : 'Non âœ—'}\`);
  console.log(\`- Classe prÃ©sente: \${hasClass ? 'Oui âœ“' : 'Non âœ—'}\`);
  console.log(\`- Metadata prÃ©sent: \${hasMetadata ? 'Oui âœ“' : 'Non âœ—'}\`);
  console.log(\`- Events prÃ©sent: \${hasEvents ? 'Oui âœ“' : 'Non âœ—'}\`);
  console.log(\`- MÃ©thode initialize: \${hasInitialize ? 'Oui âœ“' : 'Non âœ—'}\`);
  console.log(\`- MÃ©thode execute: \${hasExecute ? 'Oui âœ“' : 'Non âœ—'}\`);
  console.log(\`- MÃ©thode validate: \${hasValidate ? 'Oui âœ“' : 'Non âœ—'}\`);
  console.log(\`- MÃ©thode stop: \${hasStop ? 'Oui âœ“' : 'Non âœ—'}\`);
  
  // VÃ©rifier si le fichier semble implÃ©menter l'interface McpAgent
  const seemsValid = hasExport && hasClass && hasMetadata && hasEvents && 
                    hasInitialize && hasExecute;
  
  if (seemsValid) {
    console.log('\\nâœ… Le fichier semble contenir un agent valide implÃ©mentant l\\'interface McpAgent');
    process.exit(0);
  } else {
    console.log('\\nâŒ Le fichier ne semble pas implÃ©menter correctement l\\'interface McpAgent');
    process.exit(1);
  }
} else {
  console.error('âŒ Impossible de lire le fichier agent');
  process.exit(1);
}
EOL

# ExÃ©cuter le test JavaScript (qui ne dÃ©pend pas de TypeScript)
log "ExÃ©cution du test JavaScript pour l'agent htaccess-router-analyzer..."
node "$AGENT_TEST_SCRIPT" > "${REPORT_DIR}/htaccess-test.log" 2>&1
TEST_STATUS=$?

if [ $TEST_STATUS -ne 0 ]; then
  log "âŒ Ã‰chec du test htaccess-router-analyzer, voir ${REPORT_DIR}/htaccess-test.log"
  # Afficher les premiÃ¨res lignes du log pour diagnostiquer
  cat "${REPORT_DIR}/htaccess-test.log" >> "$CI_LOG" 
else
  log "âœ… Test htaccess-router-analyzer rÃ©ussi"
fi

# Ã‰tape 5: VÃ©rifier la compilation TypeScript avec skipLibCheck
log "ðŸ”¨ VÃ©rification de la compilation TypeScript..."

# CrÃ©er un fichier tsconfig temporaire spÃ©cifique pour CI
TEMP_TSCONFIG_COMPILE="${REPORT_DIR}/tsconfig.ci.json"

cat > "$TEMP_TSCONFIG_COMPILE" << EOL
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "CommonJS",
    "moduleResolution": "node",
    "esModuleInterop": true,
    "strict": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "outDir": "${REPORT_DIR}/dist",
    "resolveJsonModule": true
  },
  "include": [
    "${WORKSPACE_ROOT}/packages/mcp-agents/business/analyzers/htaccess-router-analyzer/**/*.ts"
  ],
  "exclude": [
    "node_modules"
  ]
}
EOL

# VÃ©rifier si des fichiers correspondants existent pour le pattern d'inclusion
MATCHING_FILES=$(find "${WORKSPACE_ROOT}/packages/mcp-agents/business/analyzers/htaccess-router-analyzer" -name "*.ts" 2>/dev/null)

if [ -z "$MATCHING_FILES" ]; then
  log "âš ï¸ Aucun fichier TypeScript trouvÃ© pour la compilation dans le chemin spÃ©cifiÃ©"
  echo "Recherche d'un autre emplacement pour l'agent..."
  
  # Rechercher l'agent dans d'autres emplacements possibles
  AGENT_PATH=$(find "${WORKSPACE_ROOT}/packages/mcp-agents" -name "htaccess-router-analyzer.ts" -o -name "index.ts" | grep -i "htaccess" | head -1)
  
  if [ -n "$AGENT_PATH" ]; then
    # Mettre Ã  jour la configuration pour inclure le fichier trouvÃ©
    AGENT_DIR=$(dirname "$AGENT_PATH")
    log "Agent trouvÃ© Ã : $AGENT_PATH"
    
    # CrÃ©er une nouvelle configuration avec le chemin correct
    cat > "$TEMP_TSCONFIG_COMPILE" << EOL
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "CommonJS",
    "moduleResolution": "node",
    "esModuleInterop": true,
    "strict": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "outDir": "${REPORT_DIR}/dist",
    "resolveJsonModule": true
  },
  "include": [
    "${AGENT_PATH}"
  ],
  "exclude": [
    "node_modules"
  ]
}
EOL
  else
    log "âŒ Impossible de trouver l'agent htaccess-router-analyzer"
    TSC_STATUS=1
  fi
fi

if [ -z "$TSC_STATUS" ]; then
  # VÃ©rifions le fichier trouvÃ©
  npx tsc -p "$TEMP_TSCONFIG_COMPILE" --noEmit > "${REPORT_DIR}/tsc.log" 2>&1
  TSC_STATUS=$?
fi

if [ $TSC_STATUS -ne 0 ]; then
  log "âŒ Ã‰chec de la compilation TypeScript, voir ${REPORT_DIR}/tsc.log"
  # Extrait des erreurs pour le log
  grep "error TS" "${REPORT_DIR}/tsc.log" | head -10 >> "$CI_LOG"
else
  log "âœ… Compilation TypeScript rÃ©ussie pour htaccess-router-analyzer"
fi

# Ã‰tape 6: VÃ©rifier la structure du projet
log "ðŸ“Š VÃ©rification de la structure du projet..."

# Compter le nombre d'agents dans les diffÃ©rentes catÃ©gories
ANALYZERS_COUNT=$(find "$WORKSPACE_ROOT/packages/mcp-agents/business/analyzers" -type f -name "*.ts" 2>/dev/null | wc -l)
GENERATORS_COUNT=$(find "$WORKSPACE_ROOT/packages/mcp-agents/business/generators" -type f -name "*.ts" 2>/dev/null | wc -l)
VALIDATORS_COUNT=$(find "$WORKSPACE_ROOT/packages/mcp-agents/business/validators" -type f -name "*.ts" 2>/dev/null | wc -l)
MISC_COUNT=$(find "$WORKSPACE_ROOT/packages/mcp-agents/business/misc" -type f -name "*.ts" 2>/dev/null | wc -l)

log "Structure des agents:"
log "- Analyzers: $ANALYZERS_COUNT"
log "- Generators: $GENERATORS_COUNT" 
log "- Validators: $VALIDATORS_COUNT"
log "- Misc: $MISC_COUNT"

# Ã‰tape 7: GÃ©nÃ©rer un rapport de rÃ©ussite ou d'Ã©chec
if [ $TEST_STATUS -ne 0 ] || [ $TSC_STATUS -ne 0 ]; then
  log "âŒ Le pipeline CI a rencontrÃ© des problÃ¨mes. Veuillez consulter les logs pour plus de dÃ©tails."
  
  # GÃ©nÃ©rer un rapport d'Ã©chec
  FAILURE_REPORT="${REPORT_DIR}/failure-report.md"
  
  cat > "$FAILURE_REPORT" << EOL
# Rapport CI/CD des agents MCP - ProblÃ¨mes dÃ©tectÃ©s
Date: $(date +'%Y-%m-%d %H:%M:%S')

## RÃ©sumÃ©
- Test htaccess-router-analyzer: $([ $TEST_STATUS -eq 0 ] && echo "âœ… RÃ©ussi" || echo "âŒ Ã‰chouÃ©")
- Compilation TypeScript: $([ $TSC_STATUS -eq 0 ] && echo "âœ… RÃ©ussie" || echo "âŒ Ã‰chouÃ©e")

## Structure du projet
- Analyzers: $ANALYZERS_COUNT
- Generators: $GENERATORS_COUNT
- Validators: $VALIDATORS_COUNT
- Misc: $MISC_COUNT

## Actions recommandÃ©es
1. Consultez les logs dÃ©taillÃ©s dans \`${REPORT_DIR}\`
2. Corrigez les problÃ¨mes signalÃ©s
3. Relancez les tests avec \`${WORKSPACE_ROOT}/ci/mcp-agents-ci.sh\`
EOL
  
  log "ðŸ“ Rapport d'Ã©chec crÃ©Ã©: $FAILURE_REPORT"
  exit 1
else
  log "âœ… Tous les contrÃ´les ont passÃ© avec succÃ¨s!"
  
  # GÃ©nÃ©rer un rapport de rÃ©ussite
  SUCCESS_REPORT="${REPORT_DIR}/success-report.md"
  
  cat > "$SUCCESS_REPORT" << EOL
# Rapport CI/CD rÃ©ussi pour les agents MCP
Date: $(date +'%Y-%m-%d %H:%M:%S')

## Tests effectuÃ©s
- âœ… VÃ©rification des scripts essentiels
- âœ… Synchronisation des agents dupliquÃ©s
- âœ… Test de l'agent htaccess-router-analyzer
- âœ… Compilation TypeScript

## Structure du projet
- Analyzers: $ANALYZERS_COUNT
- Generators: $GENERATORS_COUNT
- Validators: $VALIDATORS_COUNT
- Misc: $MISC_COUNT

## Prochaines Ã©tapes
1. VÃ©rifiez les rapports dÃ©taillÃ©s dans \`${REPORT_DIR}\`
2. ExÃ©cutez \`./update-agent-imports.sh\` pour mettre Ã  jour les imports
3. Mettez Ã  jour la documentation si nÃ©cessaire
EOL
  
  log "ðŸ“ Rapport de rÃ©ussite crÃ©Ã©: $SUCCESS_REPORT"
  exit 0
fi